using System;
using System.Drawing;
using System.Threading.Tasks;
using System.Windows.Forms;
using StudyBuddy.Models;
using StudyBuddy.Helpers;
using StudyBuddy.Controls;
using StudyBuddy.Data;

namespace StudyBuddy
{
    /// <summary>
    /// Main form with modern sidebar navigation and module system
    /// Provides access to all Study Buddy features through a clean, organized interface
    /// </summary>
    public partial class MainForm : Form
    {
        #region Private Fields

        private SettingsHandler _settingsHandler;
        private DatabaseHelper _databaseHelper;
        private UserSettings _currentSettings;
        private ThemeColors _themeColors;
        
        // Navigation
        private Button _selectedNavButton;
        private UserControl _currentControl;
        
        // Modules
        private DashboardControl _dashboardControl;
        private SummarizerControl _summarizerControl;
        private ProblemGeneratorControl _problemGeneratorControl;
        private StudyOptimizerControl _studyOptimizerControl;
        private FlashcardControl _flashcardControl;
        private ReverseQuizGenerator _reverseQuizControl;
        private AdvancedSettings _settingsControl;
        private AboutControl _aboutControl;

        #endregion

        #region Constructor and Initialization

        public MainForm()
        {
            InitializeComponent();
            InitializeAsync();
        }

        /// <summary>
        /// Initialize the application asynchronously
        /// </summary>
        private async void InitializeAsync()
        {
            try
            {
                // Show loading indicator
                ShowLoadingState();

                // Initialize core services
                _settingsHandler = new SettingsHandler();
                _databaseHelper = new DatabaseHelper();
                
                await _databaseHelper.InitializeDatabaseAsync();
                _currentSettings = await _settingsHandler.LoadSettingsAsync();
                
                // Apply theme
                ApplyTheme();
                
                // Initialize controls
                InitializeModuleControls();
                
                // Setup navigation
                SetupNavigation();
                
                // Load default module
                await LoadModuleAsync(_currentSettings.LastSelectedModule);
                
                // Apply window settings
                ApplyWindowSettings();
                
                HideLoadingState();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error initializing application: {ex.Message}", "Initialization Error", 
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        /// <summary>
        /// Initialize all module controls
        /// </summary>
        private void InitializeModuleControls()
        {
            _dashboardControl = new DashboardControl(_databaseHelper, _settingsHandler);
            _summarizerControl = new SummarizerControl(_settingsHandler);
            _problemGeneratorControl = new ProblemGeneratorControl(_settingsHandler);
            _studyOptimizerControl = new StudyOptimizerControl(_settingsHandler);
            _flashcardControl = new FlashcardControl(_databaseHelper, _settingsHandler);
            _reverseQuizControl = new ReverseQuizGenerator(_settingsHandler);
            _settingsControl = new AdvancedSettings(_settingsHandler, this);
            _aboutControl = new AboutControl();
        }

        /// <summary>
        /// Setup sidebar navigation buttons
        /// </summary>
        private void SetupNavigation()
        {
            // Clear existing navigation if any
            pnlNavigation.Controls.Clear();

            var navigationItems = new (string Name, string Icon, UserControl Control, string Description)[]
            {
                ("Dashboard", "📊", _dashboardControl, "Overview & Daily Challenge"),
                ("Summarizer", "📝", _summarizerControl, "AI Study Summarizer"),
                ("Problems", "🎲", _problemGeneratorControl, "Random Problem Generator"),
                ("Optimizer", "⏰", _studyOptimizerControl, "Study Time Optimizer"),
                ("Flashcards", "🗂️", _flashcardControl, "Memory Trigger System"),
                ("Quiz", "❓", _reverseQuizControl, "Reverse Quiz Generator"),
                ("Settings", "⚙️", _settingsControl, "App Settings & Preferences"),
                ("About", "ℹ️", _aboutControl, "Help & Information")
            };

            int yPosition = 20;
            const int buttonHeight = 60;
            const int buttonSpacing = 5;

            foreach (var item in navigationItems)
            {
                var navButton = CreateNavigationButton(item.Name, item.Icon, item.Description, yPosition);
                navButton.Tag = new NavigationItem { Name = item.Name, Control = item.Control };
                navButton.Click += NavButton_Click;
                
                pnlNavigation.Controls.Add(navButton);
                yPosition += buttonHeight + buttonSpacing;
            }
        }

        /// <summary>
        /// Create a navigation button with modern styling
        /// </summary>
        private Button CreateNavigationButton(string name, string icon, string description, int yPosition)
        {
            var button = new Button
            {
                Name = $"btn{name}",
                Size = new Size(220, 55),
                Location = new Point(10, yPosition),
                FlatStyle = FlatStyle.Flat,
                BackColor = _themeColors.Surface,
                ForeColor = _themeColors.Text,
                Font = new Font("Segoe UI Emoji", 11F, FontStyle.Regular),
                TextAlign = ContentAlignment.MiddleLeft,
                ImageAlign = ContentAlignment.MiddleLeft,
                Text = $"   {icon}  {name}",
                Cursor = Cursors.Hand,
                TabStop = false
            };

            button.FlatAppearance.BorderSize = 0;
            button.FlatAppearance.MouseOverBackColor = _themeColors.Primary;
            button.FlatAppearance.MouseDownBackColor = _themeColors.Secondary;

            // Add tooltip
            var tooltip = new ToolTip();
            tooltip.SetToolTip(button, description);

            // Hover effects
            button.MouseEnter += (s, e) =>
            {
                if (button != _selectedNavButton)
                {
                    button.BackColor = Color.FromArgb(100, _themeColors.Primary.R, _themeColors.Primary.G, _themeColors.Primary.B);
                }
            };

            button.MouseLeave += (s, e) =>
            {
                if (button != _selectedNavButton)
                {
                    button.BackColor = _themeColors.Surface;
                }
            };

            return button;
        }

        #endregion

        #region Navigation Event Handlers

        /// <summary>
        /// Handle navigation button clicks
        /// </summary>
        private async void NavButton_Click(object sender, EventArgs e)
        {
            if (sender is Button button && button.Tag is NavigationItem navItem)
            {
                await LoadModuleAsync(navItem.Name);
            }
        }

        /// <summary>
        /// Load a specific module
        /// </summary>
        /// <param name="moduleName">Name of the module to load</param>
        private async Task LoadModuleAsync(string moduleName)
        {
            try
            {
                // Update navigation selection
                UpdateNavigationSelection(moduleName);
                
                // Get the control to load
                var control = GetModuleControl(moduleName);
                if (control == null) return;

                // Clear current content
                pnlMainContent.Controls.Clear();
                
                // Load the new control
                control.Dock = DockStyle.Fill;
                pnlMainContent.Controls.Add(control);
                
                // Initialize the control if it has an async initialization method
                if (control is IAsyncInitializable asyncControl)
                {
                    await asyncControl.InitializeAsync();
                }
                
                _currentControl = control;
                
                // Update window title
                this.Text = $"Study Buddy - {moduleName}";
                
                // Save last selected module
                await _settingsHandler.UpdateSettingAsync(s => s.LastSelectedModule = moduleName);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error loading module: {ex.Message}", "Module Error", 
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        /// <summary>
        /// Get module control by name
        /// </summary>
        private UserControl GetModuleControl(string moduleName)
        {
            return moduleName switch
            {
                "Dashboard" => _dashboardControl,
                "Summarizer" => _summarizerControl,
                "Problems" => _problemGeneratorControl,
                "Optimizer" => _studyOptimizerControl,
                "Flashcards" => _flashcardControl,
                "Quiz" => _reverseQuizControl,
                "Settings" => _settingsControl,
                "About" => _aboutControl,
                _ => _dashboardControl
            };
        }

        /// <summary>
        /// Update navigation button selection visual state
        /// </summary>
        private void UpdateNavigationSelection(string moduleName)
        {
            // Reset previous selection
            if (_selectedNavButton != null)
            {
                _selectedNavButton.BackColor = _themeColors.Surface;
                _selectedNavButton.ForeColor = _themeColors.Text;
            }

            // Find and highlight new selection
            foreach (Control control in pnlNavigation.Controls)
            {
                if (control is Button navButton && navButton.Tag is NavigationItem navItem)
                {
                    if (navItem.Name == moduleName)
                    {
                        navButton.BackColor = _themeColors.Primary;
                        navButton.ForeColor = Color.White;
                        _selectedNavButton = navButton;
                        break;
                    }
                }
            }
        }

        #endregion

        #region Theme and Styling

        /// <summary>
        /// Apply current theme to the application
        /// </summary>
        private void ApplyTheme()
        {
            _themeColors = _settingsHandler.GetThemeColors();

            // Apply to main form
            this.BackColor = _themeColors.Background;
            this.ForeColor = _themeColors.Text;

            // Apply to navigation panel
            if (pnlNavigation != null)
            {
                pnlNavigation.BackColor = _themeColors.Surface;
                
                // Update existing navigation buttons
                foreach (Control control in pnlNavigation.Controls)
                {
                    if (control is Button button)
                    {
                        button.BackColor = _themeColors.Surface;
                        button.ForeColor = _themeColors.Text;
                        button.FlatAppearance.MouseOverBackColor = _themeColors.Primary;
                    }
                }
            }

            // Apply to main content panel
            if (pnlMainContent != null)
            {
                pnlMainContent.BackColor = _themeColors.Background;
            }

            // Apply to header
            if (pnlHeader != null)
            {
                pnlHeader.BackColor = _themeColors.Primary;
            }

            if (lblAppTitle != null)
            {
                lblAppTitle.ForeColor = Color.White;
            }
        }

        /// <summary>
        /// Theme changed event handler
        /// </summary>
        public async void OnThemeChanged()
        {
            ApplyTheme();
            
            // Notify all modules about theme change
            var modules = new UserControl[] 
            { 
                _dashboardControl, _summarizerControl, _problemGeneratorControl, 
                _studyOptimizerControl, _flashcardControl, _reverseQuizControl, 
                _settingsControl, _aboutControl 
            };

            foreach (var module in modules)
            {
                if (module is IThemeAware themeAware)
                {
                    themeAware.OnThemeChanged(_themeColors);
                }
            }
        }

        /// <summary>
        /// Update the application theme
        /// </summary>
        public void UpdateTheme(Theme theme)
        {
            try
            {
                // Update settings
                _currentSettings.Theme = theme;
                
                // Get new theme colors and apply
                _themeColors = GetThemeColors(theme);
                ApplyTheme();
                
                // Save the theme preference
                Task.Run(async () =>
                {
                    await _settingsHandler.UpdateSettingAsync(s => s.Theme = theme);
                });
            }
            catch (Exception ex)
            {
                // Log error but don't crash
                System.Diagnostics.Debug.WriteLine($"Error updating theme: {ex.Message}");
            }
        }

        /// <summary>
        /// Get theme colors based on theme mode
        /// </summary>
        private ThemeColors GetThemeColors(Theme theme)
        {
            return theme switch
            {
                Theme.Dark => new ThemeColors
                {
                    Background = Color.FromArgb(33, 33, 33),
                    Surface = Color.FromArgb(66, 66, 66),
                    Primary = Color.FromArgb(144, 202, 249),
                    Text = Color.White,
                    TextSecondary = Color.FromArgb(200, 200, 200)
                },
                Theme.Light => new ThemeColors
                {
                    Background = Color.White,
                    Surface = Color.FromArgb(248, 249, 250),
                    Primary = Color.FromArgb(33, 150, 243),
                    Text = Color.Black,
                    TextSecondary = Color.FromArgb(100, 100, 100)
                },
                Theme.Auto => GetSystemThemeColors(),
                _ => GetThemeColors(Theme.Light)
            };
        }

        /// <summary>
        /// Get system theme colors
        /// </summary>
        private ThemeColors GetSystemThemeColors()
        {
            // Simple system theme detection
            var isDark = SystemInformation.HighContrast;
            return GetThemeColors(isDark ? Theme.Dark : Theme.Light);
        }

        #endregion

        #region Window Management

        /// <summary>
        /// Apply saved window settings
        /// </summary>
        private void ApplyWindowSettings()
        {
            if (_currentSettings.StartMaximized)
            {
                this.WindowState = FormWindowState.Maximized;
            }
            else if (_currentSettings.RememberWindowPosition)
            {
                this.Size = new Size(_currentSettings.WindowWidth, _currentSettings.WindowHeight);
                this.StartPosition = FormStartPosition.CenterScreen;
            }
        }

        /// <summary>
        /// Save window settings before closing
        /// </summary>
        private async void MainForm_FormClosing(object sender, FormClosingEventArgs e)
        {
            try
            {
                // Save current window state
                await _settingsHandler.UpdateSettingAsync(settings =>
                {
                    settings.StartMaximized = this.WindowState == FormWindowState.Maximized;
                    if (this.WindowState == FormWindowState.Normal)
                    {
                        settings.WindowWidth = this.Width;
                        settings.WindowHeight = this.Height;
                    }
                });

                // Cleanup resources
                _dashboardControl?.Dispose();
                _summarizerControl?.Dispose();
                _problemGeneratorControl?.Dispose();
                _studyOptimizerControl?.Dispose();
                _flashcardControl?.Dispose();
                _reverseQuizControl?.Dispose();
                _settingsControl?.Dispose();
                _aboutControl?.Dispose();
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Error saving settings on close: {ex.Message}");
            }
        }

        #endregion

        #region Loading State

        /// <summary>
        /// Show loading state
        /// </summary>
        private void ShowLoadingState()
        {
            // Create and show loading panel
            var loadingPanel = new Panel
            {
                Name = "pnlLoading",
                Dock = DockStyle.Fill,
                BackColor = Color.FromArgb(248, 249, 250)
            };

            var loadingLabel = new Label
            {
                Text = "Loading Study Buddy...",
                Font = new Font("Segoe UI", 14, FontStyle.Regular),
                ForeColor = Color.FromArgb(63, 81, 181),
                AutoSize = true
            };

            loadingLabel.Location = new Point(
                (loadingPanel.Width - loadingLabel.Width) / 2,
                (loadingPanel.Height - loadingLabel.Height) / 2
            );

            loadingPanel.Controls.Add(loadingLabel);
            this.Controls.Add(loadingPanel);
            loadingPanel.BringToFront();
        }

        /// <summary>
        /// Hide loading state
        /// </summary>
        private void HideLoadingState()
        {
            var loadingPanel = this.Controls.Find("pnlLoading", false);
            if (loadingPanel.Length > 0)
            {
                this.Controls.Remove(loadingPanel[0]);
            }
        }

        #endregion

        #region Public Methods

        /// <summary>
        /// Navigate to a specific module programmatically
        /// </summary>
        /// <param name="moduleName">Module name to navigate to</param>
        public async Task NavigateToModuleAsync(string moduleName)
        {
            await LoadModuleAsync(moduleName);
        }

        /// <summary>
        /// Get current theme colors
        /// </summary>
        /// <returns>Current theme colors</returns>
        public ThemeColors GetCurrentTheme()
        {
            return _themeColors;
        }

        /// <summary>
        /// Refresh current module
        /// </summary>
        public async Task RefreshCurrentModuleAsync()
        {
            if (_currentControl is IRefreshable refreshable)
            {
                await refreshable.RefreshAsync();
            }
        }

        #endregion
    }

    #region Interfaces

    /// <summary>
    /// Interface for controls that support async initialization
    /// </summary>
    public interface IAsyncInitializable
    {
        Task InitializeAsync();
    }

    /// <summary>
    /// Interface for controls that support theme changes
    /// </summary>
    public interface IThemeAware
    {
        void OnThemeChanged(ThemeColors themeColors);
    }

    /// <summary>
    /// Interface for controls that support refreshing
    /// </summary>
    public interface IRefreshable
    {
        Task RefreshAsync();
    }

    #endregion
}